openapi: 3.0.0
info:
  title: Netflim DATA API
  version: 1.0.0
  description: |
    Microservice de gestion du catalogue vidéo (Films, Séries, Saisons, Épisodes) pour la plateforme Netflim.
    
    Ce service gère l'intégralité du catalogue avec les métadonnées associées, les relations hiérarchiques
    entre les ressources et l'intégration avec le service FILE pour la gestion des fichiers.
  contact:
    name: API Support
    url: https://github.com/ClemLy/Netflim_DATA
  license:
    name: ISC
    url: https://opensource.org/licenses/ISC

servers:
  - url: http://localhost:4000
    description: Serveur de développement
    variables:
      basePath:
        default: /api

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT pour l'authentification utilisateur
    ServiceToken:
      type: apiKey
      in: header
      name: x-service-token
      description: Token d'authentification inter-service pour les communications entre microservices

  schemas:
    Category:
      type: object
      required:
        - name
      properties:
        id:
          type: integer
          example: 1
          description: Identifiant unique de la catégorie
        name:
          type: string
          minLength: 2
          maxLength: 50
          example: Action
          description: Nom unique de la catégorie
        createdAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z
          description: Date de création
        updatedAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z
          description: Date de dernière modification

    Movie:
      type: object
      required:
        - title
        - duration
        - category_id
      properties:
        id:
          type: string
          format: uuid
          example: f47ac10b-58cc-4372-a567-0e02b2c3d479
          description: Identifiant unique du film (UUID)
        title:
          type: string
          minLength: 1
          maxLength: 255
          example: Inception
          description: Titre du film
        description:
          type: string
          example: Un thriller de science-fiction captivant
          description: Description détaillée du film
        releaseDate:
          type: string
          format: date
          example: 2010-07-16
          description: Date de sortie du film (format YYYY-MM-DD)
        duration:
          type: integer
          minimum: 1
          example: 148
          description: Durée du film en minutes
        category_id:
          type: integer
          minimum: 1
          example: 1
          description: Identifiant de la catégorie
        poster_id:
          type: string
          format: uuid
          example: a47ac10b-58cc-4372-a567-0e02b2c3d479
          nullable: true
          description: ID du fichier affiche du film (service FILE)
        video_id:
          type: string
          format: uuid
          example: b47ac10b-58cc-4372-a567-0e02b2c3d479
          nullable: true
          description: ID du fichier vidéo du film (service FILE)
        createdAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z
        updatedAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z

    Series:
      type: object
      required:
        - title
        - category_id
      properties:
        id:
          type: string
          format: uuid
          example: e47ac10b-58cc-4372-a567-0e02b2c3d479
          description: Identifiant unique de la série (UUID)
        title:
          type: string
          minLength: 1
          maxLength: 255
          example: Breaking Bad
          description: Titre de la série
        description:
          type: string
          example: Une série dramatique complexe
          description: Description détaillée de la série
        category_id:
          type: integer
          minimum: 1
          example: 2
          description: Identifiant de la catégorie
        poster_id:
          type: string
          format: uuid
          example: f47ac10b-58cc-4372-a567-0e02b2c3d479
          nullable: true
          description: ID du fichier affiche de la série (service FILE)
        createdAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z
        updatedAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z

    SeriesFull:
      type: object
      description: Série avec tous ses détails (saisons et épisodes)
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        category_id:
          type: integer
        poster_id:
          type: string
          format: uuid
        Seasons:
          type: array
          description: Liste de toutes les saisons de la série
          items:
            $ref: '#/components/schemas/SeasonFull'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Season:
      type: object
      required:
        - number
      properties:
        id:
          type: string
          format: uuid
          example: g47ac10b-58cc-4372-a567-0e02b2c3d479
          description: Identifiant unique de la saison (UUID)
        number:
          type: integer
          minimum: 1
          example: 1
          description: Numéro de la saison
        description:
          type: string
          example: La première saison de la série
          description: Description de la saison
        series_id:
          type: string
          format: uuid
          example: e47ac10b-58cc-4372-a567-0e02b2c3d479
          description: ID de la série parente
        createdAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z
        updatedAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z

    SeasonFull:
      type: object
      description: Saison avec tous ses épisodes
      properties:
        id:
          type: string
          format: uuid
        number:
          type: integer
        description:
          type: string
        series_id:
          type: string
          format: uuid
        Episodes:
          type: array
          description: Liste de tous les épisodes de la saison
          items:
            $ref: '#/components/schemas/Episode'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Episode:
      type: object
      required:
        - title
        - number
        - video_id
      properties:
        id:
          type: string
          format: uuid
          example: h47ac10b-58cc-4372-a567-0e02b2c3d479
          description: Identifiant unique de l'épisode (UUID)
        title:
          type: string
          minLength: 1
          maxLength: 255
          example: Pilot
          description: Titre de l'épisode
        number:
          type: integer
          minimum: 1
          example: 1
          description: Numéro de l'épisode dans la saison
        duration:
          type: integer
          minimum: 1
          example: 58
          nullable: true
          description: Durée de l'épisode en minutes
        video_id:
          type: string
          format: uuid
          example: i47ac10b-58cc-4372-a567-0e02b2c3d479
          description: ID du fichier vidéo de l'épisode (service FILE)
        season_id:
          type: string
          format: uuid
          example: g47ac10b-58cc-4372-a567-0e02b2c3d479
          description: ID de la saison parente
        createdAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z
        updatedAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z

    File:
      type: object
      description: Référence fichier gérée par le service FILE
      properties:
        id:
          type: string
          format: uuid
          example: f47ac10b-58cc-4372-a567-0e02b2c3d479
          description: Identifiant unique du fichier
        filename:
          type: string
          example: movie_poster.jpg
          description: Nom du fichier
        mimetype:
          type: string
          example: image/jpeg
          description: Type MIME du fichier
        size:
          type: integer
          example: 1024000
          description: Taille du fichier en octets
        url:
          type: string
          example: /uploads/f47ac10b-58cc-4372-a567-0e02b2c3d479
          description: URL d'accès au fichier
        createdAt:
          type: string
          format: date-time
          example: 2024-02-09T10:00:00Z

    Error:
      type: object
      properties:
        message:
          type: string
          example: Ressource non trouvée
          description: Message d'erreur descriptif
        statusCode:
          type: integer
          example: 404
          description: Code HTTP de l'erreur

paths:
  /api/categories:
    get:
      tags:
        - Catégories
      summary: Récupérer toutes les catégories
      description: Récupère la liste complète des catégories. Accessible sans authentification.
      operationId: getCategories
      responses:
        '200':
          description: Liste des catégories récupérée avec succès
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags:
        - Catégories
      summary: Créer une nouvelle catégorie
      description: Crée une nouvelle catégorie de contenu. Authentification JWT requise.
      operationId: createCategory
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 2
                  maxLength: 50
                  example: Thriller
      responses:
        '201':
          description: Catégorie créée avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '400':
          description: Données invalides ou manquantes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Non authentifié
        '500':
          description: Erreur serveur

  /api/categories/{id}:
    put:
      tags:
        - Catégories
      summary: Mettre à jour une catégorie
      description: Met à jour une catégorie existante. Authentification JWT requise.
      operationId: updateCategory
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID de la catégorie
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 2
                  maxLength: 50
      responses:
        '200':
          description: Catégorie mise à jour avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '400':
          description: Données invalides
        '401':
          description: Non authentifié
        '404':
          description: Catégorie non trouvée
        '500':
          description: Erreur serveur

    delete:
      tags:
        - Catégories
      summary: Supprimer une catégorie
      description: Supprime une catégorie existante. Authentification JWT requise.
      operationId: deleteCategory
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID de la catégorie à supprimer
      responses:
        '204':
          description: Catégorie supprimée avec succès
        '401':
          description: Non authentifié
        '404':
          description: Catégorie non trouvée
        '500':
          description: Erreur serveur

  /api/movies:
    get:
      tags:
        - Films
      summary: Récupérer tous les films
      description: Récupère la liste complète des films avec leurs métadonnées. Pas d'authentification requise.
      operationId: getMovies
      responses:
        '200':
          description: Liste des films récupérée avec succès
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Movie'
        '500':
          description: Erreur serveur

    post:
      tags:
        - Films
      summary: Créer un nouveau film
      description: Crée un nouveau film dans le catalogue. Authentification JWT requise.
      operationId: createMovie
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - duration
                - category_id
              properties:
                title:
                  type: string
                  minLength: 1
                  maxLength: 255
                  example: Inception
                description:
                  type: string
                  example: Un film de science-fiction
                releaseDate:
                  type: string
                  format: date
                  example: 2010-07-16
                duration:
                  type: integer
                  minimum: 1
                  example: 148
                category_id:
                  type: integer
                  minimum: 1
                  example: 1
                poster_id:
                  type: string
                  format: uuid
                video_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Film créé avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Movie'
        '400':
          description: Données invalides
        '401':
          description: Non authentifié
        '500':
          description: Erreur serveur

  /api/movies/{id}:
    get:
      tags:
        - Films
      summary: Récupérer un film par ID
      description: Récupère les détails complets d'un film spécifique.
      operationId: getMovie
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID du film
      responses:
        '200':
          description: Film récupéré avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Movie'
        '404':
          description: Film non trouvé
        '500':
          description: Erreur serveur

    put:
      tags:
        - Films
      summary: Mettre à jour un film
      description: Met à jour un film existant. Authentification JWT requise. Tous les champs sont optionnels.
      operationId: updateMovie
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID du film à mettre à jour
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  minLength: 1
                  maxLength: 255
                description:
                  type: string
                releaseDate:
                  type: string
                  format: date
                duration:
                  type: integer
                  minimum: 1
                category_id:
                  type: integer
                  minimum: 1
                poster_id:
                  type: string
                  format: uuid
                video_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Film mis à jour avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Movie'
        '400':
          description: Données invalides
        '401':
          description: Non authentifié
        '404':
          description: Film non trouvé
        '500':
          description: Erreur serveur

    delete:
      tags:
        - Films
      summary: Supprimer un film
      description: Supprime un film existant. Authentification JWT requise.
      operationId: deleteMovie
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID du film à supprimer
      responses:
        '204':
          description: Film supprimé avec succès
        '401':
          description: Non authentifié
        '404':
          description: Film non trouvé
        '500':
          description: Erreur serveur

  /api/series:
    get:
      tags:
        - Séries
      summary: Récupérer toutes les séries
      description: Récupère la liste complète des séries (sans détails des saisons). Pas d'authentification requise.
      operationId: getAllSeries
      responses:
        '200':
          description: Liste des séries récupérée avec succès
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Series'
        '500':
          description: Erreur serveur

    post:
      tags:
        - Séries
      summary: Créer une nouvelle série
      description: Crée une nouvelle série dans le catalogue. Authentification JWT requise.
      operationId: createSeries
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - category_id
              properties:
                title:
                  type: string
                  minLength: 1
                  maxLength: 255
                  example: Breaking Bad
                description:
                  type: string
                  example: Une série dramatique
                category_id:
                  type: integer
                  minimum: 1
                  example: 2
                poster_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Série créée avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Series'
        '400':
          description: Données invalides
        '401':
          description: Non authentifié
        '500':
          description: Erreur serveur

  /api/series/{id}:
    get:
      tags:
        - Séries
      summary: Récupérer une série avec tous ses détails
      description: |
        Récupère une série avec **toutes ses saisons et épisodes**.
        C'est la route à utiliser pour obtenir la structure complète d'une série.
      operationId: getSeriesFull
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la série
      responses:
        '200':
          description: Série avec tous ses détails récupérée avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeriesFull'
        '404':
          description: Série non trouvée
        '500':
          description: Erreur serveur

    put:
      tags:
        - Séries
      summary: Mettre à jour une série
      description: Met à jour une série existante. Authentification JWT requise. Tous les champs sont optionnels.
      operationId: updateSeries
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la série à mettre à jour
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  minLength: 1
                description:
                  type: string
                category_id:
                  type: integer
                  minimum: 1
                poster_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Série mise à jour avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Series'
        '400':
          description: Données invalides
        '401':
          description: Non authentifié
        '404':
          description: Série non trouvée
        '500':
          description: Erreur serveur

    delete:
      tags:
        - Séries
      summary: Supprimer une série
      description: Supprime une série existante (et toutes ses saisons/épisodes). Authentification JWT requise.
      operationId: deleteSeries
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la série à supprimer
      responses:
        '204':
          description: Série supprimée avec succès
        '401':
          description: Non authentifié
        '404':
          description: Série non trouvée
        '500':
          description: Erreur serveur

  /api/series/{seriesId}/seasons:
    post:
      tags:
        - Saisons
      summary: Créer une saison
      description: Crée une nouvelle saison pour une série. Authentification JWT requise.
      operationId: createSeason
      parameters:
        - name: seriesId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la série parente
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - number
              properties:
                number:
                  type: integer
                  minimum: 1
                  example: 1
                description:
                  type: string
                  example: La première saison
      responses:
        '201':
          description: Saison créée avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Season'
        '400':
          description: Données invalides
        '401':
          description: Non authentifié
        '404':
          description: Série non trouvée
        '500':
          description: Erreur serveur

  /api/series/seasons/{seasonId}:
    put:
      tags:
        - Saisons
      summary: Mettre à jour une saison
      description: Met à jour une saison existante. Authentification JWT requise. Tous les champs sont optionnels.
      operationId: updateSeason
      parameters:
        - name: seasonId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la saison à mettre à jour
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                number:
                  type: integer
                  minimum: 1
                description:
                  type: string
      responses:
        '200':
          description: Saison mise à jour avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Season'
        '400':
          description: Données invalides
        '401':
          description: Non authentifié
        '404':
          description: Saison non trouvée
        '500':
          description: Erreur serveur

    delete:
      tags:
        - Saisons
      summary: Supprimer une saison
      description: Supprime une saison existante (et tous ses épisodes). Authentification JWT requise.
      operationId: deleteSeason
      parameters:
        - name: seasonId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la saison à supprimer
      security:
        - BearerAuth: []
      responses:
        '204':
          description: Saison supprimée avec succès
        '401':
          description: Non authentifié
        '404':
          description: Saison non trouvée
        '500':
          description: Erreur serveur

  /api/series/seasons/{seasonId}/episodes:
    post:
      tags:
        - Épisodes
      summary: Créer un épisode
      description: Crée un nouvel épisode pour une saison. Authentification JWT requise.
      operationId: createEpisode
      parameters:
        - name: seasonId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la saison parente
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - number
                - video_id
              properties:
                title:
                  type: string
                  minLength: 1
                  maxLength: 255
                  example: Pilot
                number:
                  type: integer
                  minimum: 1
                  example: 1
                duration:
                  type: integer
                  minimum: 1
                  example: 47
                video_id:
                  type: string
                  format: uuid
                  description: ID du fichier vidéo (obtenu du service FILE)
      responses:
        '201':
          description: Épisode créé avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Episode'
        '400':
          description: Données invalides
        '401':
          description: Non authentifié
        '404':
          description: Saison non trouvée
        '500':
          description: Erreur serveur

  /api/series/episodes/{episodeId}:
    put:
      tags:
        - Épisodes
      summary: Mettre à jour un épisode
      description: Met à jour un épisode existant. Authentification JWT requise. Tous les champs sont optionnels.
      operationId: updateEpisode
      parameters:
        - name: episodeId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID de l'épisode à mettre à jour
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  minLength: 1
                number:
                  type: integer
                  minimum: 1
                duration:
                  type: integer
                  minimum: 1
                video_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Épisode mis à jour avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Episode'
        '400':
          description: Données invalides
        '401':
          description: Non authentifié
        '404':
          description: Épisode non trouvé
        '500':
          description: Erreur serveur

    delete:
      tags:
        - Épisodes
      summary: Supprimer un épisode
      description: Supprime un épisode existant. Authentification JWT requise.
      operationId: deleteEpisode
      parameters:
        - name: episodeId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID de l'épisode à supprimer
      security:
        - BearerAuth: []
      responses:
        '204':
          description: Épisode supprimé avec succès
        '401':
          description: Non authentifié
        '404':
          description: Épisode non trouvé
        '500':
          description: Erreur serveur

  /api/files:
    post:
      tags:
        - Fichiers (Inter-service)
      summary: Créer une référence fichier
      description: |
        **⚠️ Endpoint réservé au service FILE**
        
        Crée une référence fichier dans la base de données.
        Authentification inter-service requise (x-service-token).
      operationId: createFile
      security:
        - ServiceToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                filename:
                  type: string
                  example: movie_poster.jpg
                mimetype:
                  type: string
                  example: image/jpeg
                size:
                  type: integer
                  example: 1024000
                url:
                  type: string
                  example: /uploads/f47ac10b-58cc-4372-a567-0e02b2c3d479
      responses:
        '201':
          description: Fichier créé avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/File'
        '403':
          description: Accès inter-service refusé
        '500':
          description: Erreur serveur

  /api/files/{id}:
    get:
      tags:
        - Fichiers (Inter-service)
      summary: Récupérer les métadonnées d'un fichier
      description: |
        **⚠️ Endpoint réservé au service FILE**
        
        Récupère les métadonnées d'un fichier.
        Authentification inter-service requise (x-service-token).
      operationId: getFile
      security:
        - ServiceToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID du fichier
      responses:
        '200':
          description: Fichier trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/File'
        '403':
          description: Accès inter-service refusé
        '404':
          description: Fichier non trouvé
        '500':
          description: Erreur serveur

    delete:
      tags:
        - Fichiers (Inter-service)
      summary: Supprimer une référence fichier
      description: |
        **⚠️ Endpoint réservé au service FILE**
        
        Supprime la référence d'un fichier en base de données.
        Authentification inter-service requise (x-service-token).
      operationId: deleteFile
      security:
        - ServiceToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID du fichier à supprimer
      responses:
        '204':
          description: Fichier supprimé avec succès
        '403':
          description: Accès inter-service refusé
        '500':
          description: Erreur serveur

tags:
  - name: Catégories
    description: Gestion des catégories de contenu (public)
  - name: Films
    description: Gestion des films (public en lecture, privé en écriture)
  - name: Séries
    description: Gestion des séries (public en lecture, privé en écriture)
  - name: Saisons
    description: Gestion des saisons de séries (privé)
  - name: Épisodes
    description: Gestion des épisodes de séries (privé)
  - name: Fichiers (Inter-service)
    description: Communication inter-services avec le service FILE (réservé)
